### 视频流处理流水线

**文件**: `app/core/pipeline.py`

#### 三阶段流水线架构：

1. **Reader线程** (T1)
   - 从视频源（摄像头/文件/URL）读取帧
   - 使用非阻塞队列put，避免阻塞停止信号
   - 智能丢帧

2. **Inference线程** (T2)
   - 使用检测模型进行人脸检测
   - 输出人脸边界框和5点关键点坐标
   - 批量处理提高效率

3. **Postprocessor线程** (T3)
   - 人脸对齐裁剪（使用5点关键点）
   - 特征提取和向量化
   - 向量数据库相似度搜索
   - 结果绘制和帧编码输出

### 3. 人脸对齐与特征提取

```python
def align_and_crop(img: np.ndarray, landmarks: List[Union[List[float], np.ndarray]], image_size: int = 112) -> Tuple[np.ndarray, np.ndarray]:
    """
    根据给定的关键点对齐并裁剪图像中的人脸。
    此函数直接改编自参考文档，是提升识别精度的核心。

    Args:
        img: 完整的原始图像 (未经裁剪的边界框)
        landmarks: 5个关键点（界标）的列表，格式为 (x, y) 坐标
        image_size: 图像应被调整到的大小，默认为112

    Returns:
        对齐后的人脸图像和变换矩阵
    """
    # ArcFace模型中使用的参考关键点
    _arcface_ref_kps = np.array([
        [38.2946, 51.6963],  # 左眼
        [73.5318, 51.5014],  # 右眼
        [56.0252, 71.7366],  # 鼻子
        [41.5493, 92.3655],  # 左嘴角
        [70.7299, 92.2041],  # 右嘴角
    ], dtype=np.float32)

    # 输入验证
    assert len(landmarks) == 5, f"需要5个关键点进行对齐，但收到了 {len(landmarks)} 个。"
    assert image_size % 112 == 0 or image_size % 128 == 0, "图像尺寸必须是112或128的倍数。"

    # 根据目标尺寸计算缩放因子和偏移
    if image_size % 112 == 0:
        ratio = float(image_size) / 112.0
        diff_x = 0  # 112缩放无水平偏移
    else:
        ratio = float(image_size) / 128.0
        diff_x = 8.0 * ratio  # 128缩放有水平偏移

    # 应用缩放和偏移到参考关键点
    dst = _arcface_ref_kps * ratio
    dst[:, 0] += diff_x

    # 使用RANSAC算法估计相似性变换矩阵
    M, inliers = cv2.estimateAffinePartial2D(
        np.array(landmarks, dtype=np.float32), 
        dst, 
        ransacReprojThreshold=1000
    )
    
    # 健壮性检查：如果对齐失败，返回空图像
    if inliers is None or not np.all(inliers):
        return np.zeros((image_size, image_size, 3), dtype=np.uint8), np.zeros((2, 3), dtype=np.float32)

    # 应用仿射变换对齐人脸
    aligned_img = cv2.warpAffine(img, M, (image_size, image_size), borderValue=0.0)

    return aligned_img, M
```

**关键点对齐算法详解**:

1. **参考关键点定义**:
   - 使用ArcFace标准定义的5个关键点坐标
   - 左眼: (38.2946, 51.6963)
   - 右眼: (73.5318, 51.5014) 
   - 鼻子: (56.0252, 71.7366)
   - 左嘴角: (41.5493, 92.3655)
   - 右嘴角: (70.7299, 92.2041)

2. **尺寸适配逻辑**:
   - 支持112x112和128x128两种标准尺寸
   - 自动计算缩放比例和水平偏移
   - 确保与模型训练时预处理方式一致

3. **变换矩阵估计**:
   - 使用`cv2.estimateAffinePartial2D`函数
   - RANSAC算法提供鲁棒性，阈值设为1000像素
   - 计算从检测关键点到参考关键点的相似变换

4. **图像变换**:
   - 应用估计的仿射变换矩阵
   - 使用双线性插值进行图像变形
   - 边界区域填充黑色(0值)

5. **错误处理**:
   - 关键点数量验证
   - 尺寸兼容性检查  
   - 变换失败时返回空白图像避免后续错误

### 4. 向量数据库检索

**文件**: `app/service/face_dao.py`

```python
class LanceDBFaceDataDAO:
    def search(self, embedding, threshold=0.5, top_k=1):
        # 使用余弦相似度进行向量搜索
        # 返回相似度最高的匹配结果
        # 阈值过滤确保识别准确性
```

## 人脸识别业务流程

### 1. 人脸注册流程

```
    # 从模型池借用模型
    # 图像解码和人脸检测
    # 单张人脸验证
    # 人脸对齐和特征提取
    # 特征向量存入LanceDB
    # 人脸图像保存到文件系统
    # 归还模型到池中
```

### 2. 静态图像识别流程

```
    # 从模型池借用模型
    # 图像解码和人脸检测
    # 多人脸批量处理
    # 人脸对齐和特征提取
    # 批量向量数据库搜索
    # 结果过滤和格式化
    # 归还模型到池中
```